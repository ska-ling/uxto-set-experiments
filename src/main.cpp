#include <fmt/core.h>

#include <utxo/common.hpp>



// int main(int argc, char** argv) {

//     // std::string_view const path = "/home/fernando/dev/blocks-raw";
//     std::string_view const path = "/mnt/ssd/blocks-raw";

//     size_t total_inputs;
//     size_t total_outputs;
//     size_t partial_inputs;
//     size_t partial_outputs;

//     process(path,
//         [&](auto const& tx_hashes, auto&& txs) {
//             fmt::print("txs.size() = {}\n", txs.size());
//             fmt::print("do something with txs\n");
//         },
//         [&]() {
//             fmt::print("post processing\n");
//         },
//         total_inputs, total_outputs, partial_inputs, partial_outputs);

//     fmt::print("Total inputs:    {}\n", total_inputs);
//     fmt::print("Total outputs:   {}\n", total_outputs);
//     fmt::print("Partial Inputs:  {:7}\n", partial_inputs);
//     fmt::print("Partial Outputs: {:7}\n", partial_outputs);

//     return 0;
// }


// Test parsing of block # 168502

int main() {
    constexpr size_t block_idx = 168502;
    std::string block_hex = "01000000743F6EB191B11711B1ADAEB6EE3FBED4776ADC37269F41B582050000000000008EEFE293FC7305190F342A18A2C38C99EDD7A7A38D7F6E4C59BF9A8C21F72330DD81494F9C300C1A01EC37000601000000010000000000000000000000000000000000000000000000000000000000000000FFFFFFFF4D0F00456C6967697573004F4981DD0149FABE6D6D54215600C533D332E6085A106786251BF3025ACBC0713A983ED79F25E8EBD0AE0800000000000000004E4F5032534800703273682F43485600FFFFFFFF305677C208000000001976A914BE00333C4915F72EA0B2FC6A167E980CFE660AF288ACB6750704000000001976A9147E6B2A07E51A54D8FE1F4BC6287D904E2D1CB3F088AC69B0A90A000000001976A914F8C81175752D157E5DC99653F19BAAC8296DA9C088AC5E9F2407000000001976A9149EB551C3924ED46408B3616242DB21B7FCC7F9A288ACA95A8A06000000001976A9140E33032CB3632EB98FC76FC45BD515A4BCDA148488ACBEDB3A04000000001976A914BC96571E38420C582320C867D69C4F6F2061469B88AC30C13205000000001976A91480D9DB836764688C1317808E5C62FBBCAEC662E788ACA47F4508000000001976A914E65E85BA8187C34BCC72544CF8C7ED609BA6C53788ACB8EEDF06000000001976A9142FCF7D1C9670945EA5CC614219B67F823181403488AC7E9EC508000000001976A914776C25E07FA49E549944D24ACEF7A3A3D94818CA88AC73AD5D04000000001976A9146BEA5B67D6D1DA7EF3D7B4231FEA4C8E43F6AD8888ACEF778A06000000001976A9141139DAD1A13049A46F8FE561DC4B6EE3693785CB88AC8A340604000000001976A9140E08D60695953DCC4446BEBF04C8E86A6FBA044B88AC80986B04000000001976A914BA133D57275C45340DF72DEFA1E829723DD9798788AC517F2304000000001976A9147DE940F91C3B526D77D8F7589F11172EF47286A488AC799E1804000000001976A914E51B67AAE074CAB3E83DF7DD777CE541DB9A731A88ACDAD96504000000001976A9142FDC70416F2ECB42DFA9D03E46C0C3E5309866A088ACA3B8F20C000000001976A914B7B2C010C219CF5300FC3C33D5E4E52A7A90283588AC60EC0404000000001976A9143A72B27A6EAF5CC20F4BEED81FAF2467EB2F5A0588AC32EDB104000000001976A9141B498A462CAFB9FFD0E420634F35C47CF509B87C88AC87080004000000001976A91406B379392A3E7BBA0C302D3EAF1B107631BD1AAF88AC26D53D04000000001976A9142F9DF4E19B8473B9345755E29829E801BABA01FF88ACFECC1F04000000001976A914B0C2567ECC75A6748D44BC7022035EFF3B56455A88AC27546604000000001976A914532D4BDAB6792CFF1FFB4384EC5308814A19362888ACDADF930B000000001976A9142A7C5779B4D580794CA7842CD7D17843480C951788AC2996E806000000001976A9146E56EE785925E6B8C70AF1B4891F439986B6EC5B88AC525FA309000000001976A91413CDF9562FC9ABC2216B019D2A7205C9ED54C9DE88AC5D630B04000000001976A91406B371DA8A8292F07DA1A5256D143D48D971331888AC2B33E009000000001976A91417AD6AC1056D12CC67661A24F4B30CF989DFFF3488AC0BAB2C04000000001976A914323B8A16EDCDFE3DCEE2E34CDDD672182D1EC04788AC0A79200A000000001976A9149465FDAC29B5C47B99C8D17379D0FC6D99C1E4A688AC8D460304000000001976A914CD5813B9E4B38EAE5C99EEABD76D09D346BD9C2688ACDDE30409000000001976A9142777969C44603D882A064E693276BE0B2A552B9088ACAB867806000000001976A9148E49DC353C3D09DDD992925066A80486CE79A5F988ACBD942204000000001976A91443F5F79A3B2C806235DB2D9FAC59B88B40DAC49E88AC05580104000000001976A9148756006EA9CF419A6A5D83633818A7A196EFC07488AC58474F09000000001976A9140A35976D3E01376AB328163A9E18143B65F8878188AC8F4A5504000000001976A9140CF3014E03F9BF8FB8CB806FF46EE94D9F2AC0E188AC9593AB09000000001976A9145C75F2BDA4853B40E66D73330D716F9E29FDEC5488AC465F7B04000000001976A914220B8D06C0954DA6D4434AAC55B6478B116F0D6B88AC60F72F07000000001976A91485F6BF61A152329B03DC6869566195BD4E9BB93E88ACA2650404000000001976A91406B371DAC20193557F4E4296E36714D120461CAA88AC14FD8704000000001976A914C5293F287A1594877ED0F39A87E5FB4A26A5C43688AC57844504000000001976A9142E451F91E9F756BB77A8A4C19B89106A72D56E2888ACF2893B06000000001976A914CC48BC094901E59D9F696B4D8B5C6045006BD33188ACD4F63609000000001976A914612C126A1840253DF9998E762036DEB08209CEA788AC67C5EA07000000001976A914037E2F7584B016C53D3EE9728458AC4B265BBD1788ACE0ADFE01000000001976A9145399C3093D31E4B0AF4BE1215D59B857B861AD5D88AC0000000001000000024AC709B0D634A973306834EDF5BF63D01BC533D2159D6A799FF4CE1EBA1FB0C6010000008B4830450220566D374706B391F2F6CB6E71CB92B024EAE0DB2779A6D3D786014224854DAE4C022100E60B635B1DCB795AABD5E32B4006DD6B1F6E08AF44475338F72053943897880A01410491608E8C2CD5DDC8904B4AD46A05BA79A7E7CB9978E6ACC98F912240656B39B0B1867259BDE5ABEC267158319E626A2DFE2BE07873E102396E8D3C8125AA7C1CFFFFFFFF0B731117E0B2C4938C5F6AE9056026D8E60EDF0A30F63B81D811F9669856A25A010000008C493046022100A22C000CAE0D254AEB9BDC97212350A42A5AC32D5EC0EA426F0A6702AABF8D67022100B1087DDCBC362592C030DC5F7D46EB782F890CD0B314248CAD886CC6C22905BC0141046134D097D878A80FC9930EBFC26D403D97FE124DA502DB0AA033EAA280570FCF57FA7B3015C96E49C9BC34752C050A8ABD36F9D07390EF3EF416398E2C59A5DAFFFFFFFF0140059219000000001976A914D4605726C26AFB03B9F9DA6F56865BB6FA5807EF88AC000000000100000001C2DA9281B2D3C9D57298DD926C426128619E48AEA7743FAF7EE8F76D08F277FC020000008A4730440220065588EB05D09882679E2FC65D4BFFE2EE1048BF3C010D48E6C6A1DB56CE30A402205D6000A5AEF040C5F64701B0B0D4EE749016EF5A72C69B3655A3D7489F6B8378014104E2EFC0C44979B708CA5219F4F2D4C0E9BF2D633781DD4C56E73EA5B419B483879A0644D8F783BFFC006BB1F564CDC56377CA7D629998A16FF3AB46A3F2667322FFFFFFFF0A429F1C00000000001976A914A8BF8B2E86F28ED00E6A12AB08C3AE54CE17A0AA88AC6B8A0900000000001976A914AA5BDC41527C02FFFD245F99C4475895ABF55D6488AC429F1C00000000001976A914E7622567A199EC50EC5F0F00F9B817DAD6FA2BBB88ACA673AEA8000000001976A914B47A2F8000D2D5AAD26895A3A959D3938C9F5D5788AC6B8A0900000000001976A914C4C1378E637F6EB4BFC9B565A8A139D01B0FCE6488ACD6141300000000001976A914BEC7E34632E2E1826BA9ABC225FAD21F5588330688ACD6141300000000001976A914BBEA4849CAB2A8AAB0E2EB53DAAC4B7E6B49F3C088AC92B82F02000000001976A91418C04064DFD903051F2F53AC3770F28E3E40D68888AC8FB80C00000000001976A9142157F8BE5073257D4EC0E19A3FEAFA4241027D2188AC833E3900000000001976A9142E7F2C5587043A1FB46D8170A00E2B4D587C9BE488AC00000000010000000131D8C37E851F4291828988FE1AF59D2DA9DE62175A11A0885609733D0D7ECB6E000000008C493046022100F839BDCDD4492128237D4B3D328362E23798CD83D121A6182A7254843AAE2D3C022100BF79CE708F23163DA2E6F5C37D5F1E144F5CEC3AC259B750CB1C0EE566D1F6110141041634163BCC458E9EB2A9E0EFC9DE15A8C1DCABC67E9088C2767C8B8D61BF27C94715C7A87054357D4F3CB4D21F30BB782C6937F757157D3B6E486B32BD6BDB22FFFFFFFF024E52CD6F000000001976A91477A97B000594ED69C63182D4CF66B19F906A187B88AC862F6802000000001976A914B5A1897FE1DBC0892CFBCD211B251CDD078E490C88AC000000000100000008DEC70C6D85366462976439D43AE0F11CCCEDF8300D55D1FBF7F7579AD91B7FD0010000008B483045022070765EC4623FE0DA9B6C350812E0404163AA2F4B74A247E582D4640288A735DA022100CA28304C1195872D22A1C2F5DF33419D38D85851FF297A6FF716D41995A9A97D0141041871BD464B7DFC93280F9851DD6B98A52E1E2127CCEAE95E168EF5A9427C5F358E5642154566353CA33A0795FB40DBB33461130DC5479D7FAE85A7A2C88F833DFFFFFFFFEBA4E537A3FD82D9E8979EE11DDF16BDA1CAF706BB587294A95EE163E025D544000000008B483045022100A0D10963240133AC614EB9EF8DD0DEC999BCE8D9B012DD14D286DBA3255AD92B02200404CAB057529C3B83AE56D1FCF0A0BA7D1FAE32EBC75B7B2BD7AE53A72D26D30141044F575347A9A3C1264D28801D4CE3EF393B0BE020D551CC6A4A41BBDBE92D5ABCAD460BD43C8341FE66F70BC52D38C22AAC87414B8F842AD91D86407A0880E85EFFFFFFFFB297A0FFA1D9EE1D7246136AA947AB7570BD3BA5FA8AA748969DE0F1C080AFB3000000008A473044022019147E44A43B03215DB58F66304EC7395542C0BFAA0C769332EA2EEC4F1C18AA022027F649A221B89C32051456DAAD29D8967372FBC243FBEC82806A60EB775C3A0D0141043F1CC7C5579E76FEBE4F5FFF88D611AD815A883C9CB6C238EB1948CAC0D809D31B1F38BA52174CC93E9D2235D70B9D376B38B4ADFEB7BCC65E09245CEED2706EFFFFFFFF2BBC66A3B447619785F25B2A62BD21228B306B0E2783412313734D71B4CCEA54010000008C49304602210083A9E7245D33B39B0521CA546511A130A257FD4763782FE31FEB14979122765F022100984285AE4E21BAE3C9A9884843485A6DFAB326853012777B3874FCE06971371A014104F8EC3F4CB3D35F03A43B581AB680A6E5282273AE9FBF96BDF1A1CA564B08972F410C7FB33F13A630AC56C9C5A91FF3DB330855D575DCEDA0DAEE1033F2FC08A7FFFFFFFF8D090A20645BB956F071E3D63E70B3D118A577E055CBBEFFE1349C96435E8001010000008B483045022100DCFFD5901A73124B033E8D291103B8C7337DF8C69394C631E7F66EDDF5EB04260220635E7B79FAA9047005F3D9378A81A9DDAE53AB4A8FFC3CA52DCF5930F26B84B90141042EA5E8AB96344CF02244FB09D2E971FE3CE5763B0259E794D2D534F2210CB47CCBABC2C19B0EC135107A2B7C4DB6CC1D7BE9CD484482B8B49EF3E59DF48CF889FFFFFFFF7FDDB58A316BE1C9716A8EB6309255EA304D27FE6DC9FB28F416D1C1547094DD010000008B483045022100967E3D6B0F5E275EA173DB28C49625553EE6BD49FF9021479CB383B3AB3BF1DF0220623C34ED0E7CB8F2E6325A0289AEC5222ADFFC88BD69383A1AEBA4C5803EEA22014104C88541BA712155186B17422310250AD378F4BAD509442DA836FFD91E54410DD6B7AD5647DD5D79B18AC20C20E1D7C0CB3202A5AE7CDDDE86C965E4C2A2C1A503FFFFFFFFC1EE10C31C52C731C6E7A68E68D9F11102B6042E41BE12035B6AD20802DD54E2010000008B483045022100C1C3DF7DB6D5E0149B4A6A5DE11065A6D1C64182BAFB8CEE1D515638F454AECF02205DA963DFBD9C6E69EDBA7E149714D0614BB2678DB50CD9808BCB7DC051FE3D63014104F080276DD6660C171C96F90206017F7CDED35EB247533490A4A00E3FCE4499F13421513FAFB85C42561394C02A2EE3B4AAB26DD4E4189DB88476263360D3A8CCFFFFFFFF9D4B0ECE35B6CDCD38EA388BD6F5AAE79580E8D27FABA468D96A27442E263DD5000000008B483045022049DC8733B61DF2C6F3B544917A0BA30C3C981BD4F86E79832F1218D69ECF8D1F022100AB6052BC8D1CA1CC4185D03834892B3C09F52C1BEC9893C5E4E82FD70F029238014104DFCA096FB108D5BE961837872B94EA4EC893344D956EC1C97F02C51A5C11FC97669A4C21FDE25DCD64EE411616A379E60F03EBA7634578412C25306E36716BF0FFFFFFFF023A331600000000001976A91422C1ADE06899877AD49B1B417A8584FB5AAD2C3188ACC02C922B000000001976A914F53E9E9E1AA01AE305C224CBBDD08CF2E2AD9A8A88AC000000000100000001176D5C5F113528E6CAC329C8A740B7F2F20F1C19B2DF4ECA1460A0F64F33D297000000008A473044022001F59E24FFAD1D9B3FCC71F36DADA0414B90E842A9DFC25FC0B8ADF58ED763FF02206228C90AEA503BE67F8CA406EEBBC59EAFE097A889BF1B715FCC9B0846E44D39014104773729DB4821CB09925D5DABFF25BA559805CB8836E2D535E9B9EE967EDA5827FB35C7FF555F1A5A5AC44BF2C8DB9788AF81AA4798A845918D1F6860E0703DD2FFFFFFFF02C03AE501000000001976A91410E07C3D5B9E44EC0DC0C0045CAEDC402C7354D888AC90691104000000001976A914464448AAF136C4DCD854C1C6597E66EC80991E7188AC00000000";
    auto const block_data = hex2vec(block_hex.data(), block_hex.size());

    std::string message = fmt::format("before parsing block - block {}", block_idx);
    print_memory_usage(message);
    fmt::print("block size: {}\n", block_data.size());

    kth::domain::chain::block blk;
    kth::domain::entity_from_data(blk, block_data);
    message = fmt::format(" after parsing block - block {}", block_idx);
    print_memory_usage(message);
    auto const valid = blk.is_valid();

    if ( ! valid) {
        // Should not happen
        fmt::print("****** INVALID BLOCK ******\n");
        std::terminate();
    }

    fmt::print("block is valid - tx count: {}\n", blk.transactions().size());

}

